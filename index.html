<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INIAD MULTI-CONSOLE V7.0</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --blue: #004098; --orange: #e67e22; --bg: #e0e0e0; --frame: #333; }
        body { background: var(--bg); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
        #console-frame { background: var(--frame); width: 95%; max-width: 600px; min-height: 95vh; margin: 10px; border-radius: 20px; border-bottom: 8px solid #222; padding: 20px; box-sizing: border-box; color: white; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .screen { background: #fff; border-radius: 10px; color: #333; padding: 15px; min-height: 520px; box-shadow: inset 0 0 15px rgba(0,0,0,0.5); overflow-y: auto; }
        .hidden { display: none !important; }
        .btn { padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; border: none; width: 100%; margin: 8px 0; font-size: 1rem; transition: 0.1s; }
        .btn:active { transform: scale(0.97); }
        .btn-blue { background: var(--blue); color: #fff; }
        .btn-orange { background: var(--orange); color: #fff; }
        .btn-gray { background: #eee; color: #333; border: 1px solid #ccc; }
        .ito-card { width: 45px; height: 65px; border: 2px solid var(--blue); border-radius: 5px; display: inline-flex; flex-direction: column; justify-content: center; align-items: center; margin: 2px; font-weight: bold; background: white; }
        .hand-area { width: 80px; height: 110px; background: var(--blue); color: white; margin: 10px auto; border-radius: 10px; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; font-size: 0.8rem; }
        .num-view { position: absolute; width: 100%; height: 100%; background: #fff; border: 3px solid var(--blue); border-radius: 10px; color: var(--blue); font-size: 2.5rem; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; }
        .hand-area:active .num-view { opacity: 1; }
        .kw-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 10px 0; }
        .kw-box { border: 1px solid var(--blue); padding: 10px 2px; border-radius: 5px; font-size: 0.75rem; background: #f9f9f9; text-align: center; font-weight: bold; }
        .log-table { width: 100%; font-size: 0.7rem; border-collapse: collapse; margin-top: 15px; }
        .log-table th, .log-table td { border: 1px solid #ddd; padding: 5px; text-align: center; }
        .res-success { background: #e3f2fd; color: var(--blue); font-weight: bold; }
        .res-intercept { background: #fff3e0; color: var(--orange); font-weight: bold; }
        .reset-link { font-size: 0.7rem; color: #999; margin-top: 20px; cursor: pointer; text-decoration: underline; display: block; text-align: center; }
    </style>
</head>
<body>

<div id="console-frame">
    <div style="text-align:center; margin-bottom:10px; font-weight:bold; font-size: 0.7rem;">INIAD GAME CONSOLE V7.0</div>
    <div class="screen">
        <div id="view-login">
            <h2 style="text-align:center; margin-top:60px;">SYSTEM BOOT</h2>
            <input type="text" id="in-name" class="btn btn-gray" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" style="box-sizing: border-box;">
            <button onclick="Core.login()" class="btn btn-blue">START</button>
        </div>
        <div id="view-portal" class="hidden">
            <p id="u-display" style="font-weight:bold; color:var(--blue); border-bottom:1px solid #ddd; padding-bottom:5px;">User: ---</p>
            <button onclick="Core.loadGame('ito')" class="btn btn-blue">ğŸƒ Ito (100 Themes)</button>
            <button onclick="Core.loadGame('de')" class="btn btn-orange">ğŸ”’ Decrypto</button>
        </div>
        <div id="view-game" class="hidden">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
                <button onclick="Core.eject()" style="border:none; background:none; cursor:pointer; color:#888;">â—€ EJECT</button>
                <div id="game-tag" style="background:#eee; font-size:0.7rem; padding:2px 10px; border-radius:10px; font-weight:bold;"></div>
            </div>
            <div id="game-content"></div>
        </div>
    </div>
</div>

<script>
// --- CORE SYSTEM ---
const firebaseConfig = { databaseURL: "https://noyu-d5611-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const Core = {
    user: "", currentGame: null,
    login() {
        this.user = document.getElementById('in-name').value.trim();
        if(!this.user) return;
        document.getElementById('u-display').innerText = "User: " + this.user;
        this.show('view-portal');
    },
    show(id) {
        ['view-login', 'view-portal', 'view-game'].forEach(v => document.getElementById(v).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    },
    loadGame(gid) {
        this.currentGame = gid;
        document.getElementById('game-tag').innerText = gid.toUpperCase();
        this.show('view-game');
        if(gid==='ito') Ito.init(); else Decrypto.init();
    },
    eject() {
        db.ref(this.currentGame).off();
        this.currentGame = null;
        this.show('view-portal');
    }
};

// --- ITO SYSTEM (100 Themes) ---
const Ito = {
    myNum: 0,
    drawCount: 0,
    themes: [
        {n:"ã‚³ãƒ³ãƒ“ãƒ‹å•†å“", s:"1:å®‰ã„ â†” 100:é«˜ã„"}, {n:"ãªã‚ŠãŸã„è·æ¥­", s:"1:ä¸äººæ°— â†” 100:äººæ°—"}, {n:"æ­¦å™¨ã®å¼·ã•", s:"1:å¼±ã„ â†” 100:å¼·ã„"}, {n:"çµ¦é£Ÿã®äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼", s:"1:ä¸äººæ°— â†” 100:äººæ°—"}, {n:"æ€–ã„ã‚‚ã®", s:"1:æ€–ããªã„ â†” 100:æ€–ã„"}, {n:"ãƒ¢ãƒ†ã‚‹è¶£å‘³", s:"1:ãƒ¢ãƒ†ãªã„ â†” 100:ãƒ¢ãƒ†ã‚‹"}, {n:"æœ€å¼·ã®èª¿å‘³æ–™", s:"1:å¼±ã„ â†” 100:å¼·ã„"}, {n:"æ­´å²ä¸Šã®äººç‰©", s:"1:ç„¡å â†” 100:å‰å¤§"}, {n:"ç„¡äººå³¶æŒå‚ç‰©", s:"1:ä¸è¦ â†” 100:å¿…è¦"}, {n:"ç—›ã„ã‚±ã‚¬", s:"1:å¹³æ°— â†” 100:æ¿€ç—›"},
        {n:"ã‚«ãƒƒã‚³ã„ã„è‹—å­—", s:"1:å¹³å‡¡ â†” 100:æœ€é«˜"}, {n:"æ¬²ã—ã„è¶…èƒ½åŠ›", s:"1:åœ°å‘³ â†” 100:æœ€å¼·"}, {n:"ãƒ‡ãƒ¼ãƒˆå ´æ‰€", s:"1:æœ€æ‚ª â†” 100:æœ€é«˜"}, {n:"æœ€å¼·ã®å‹•ç‰©", s:"1:å¼±ã„ â†” 100:å¼·ã„"}, {n:"äººç”Ÿã§å¤§åˆ‡ãªã‚‚ã®", s:"1:ä¸è¦ â†” 100:å¿…é ˆ"}, {n:"å«Œã„ãªé£Ÿã¹ç‰©", s:"1:å¹³æ°— â†” 100:ç„¡ç†"}, {n:"æ³£ã‘ã‚‹æ˜ ç”»", s:"1:ç¬‘ãˆã‚‹ â†” 100:å·æ³£"}, {n:"ä½ã¿ãŸã„å ´æ‰€", s:"1:å«Œ â†” 100:ç†æƒ³"}, {n:"ã‚«ãƒƒã‚³ã„ã„è‹±å˜èª", s:"1:ãƒ€ã‚µã„ â†” 100:æœ€é«˜"}, {n:"ä¸€ç™ºèŠ¸ã®é¢ç™½ã•", s:"1:å¯’ã„ â†” 100:çˆ†ç¬‘"},
        {n:"è²°ã£ã¦å¬‰ã—ã„ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ", s:"1:å›°ã‚‹ â†” 100:å¬‰ã—ã„"}, {n:"å¼·ãã†ãªæ¼¢å­—", s:"1:å¼±ãã† â†” 100:å¼·ãã†"}, {n:"ç¾å‘³ã—ã„é£²ã¿ç‰©", s:"1:ä¸å‘³ã„ â†” 100:æœ€é«˜"}, {n:"é­”æ³•ã®å¼·ã•", s:"1:åˆç´š â†” 100:ç¦å¿Œ"}, {n:"çµ¶æ»…ã—ã¦ã»ã—ã„è™«", s:"1:å¹³æ°— â†” 100:çµ¶æ»…å¸Œæœ›"}, {n:"æ­´å²äººç‰©ã®å‡„ã•", s:"1:å¾®å¦™ â†” 100:ä¼èª¬"}, {n:"è‡ªåˆ†ã¸ã®ã”è¤’ç¾", s:"1:å®‰ä¾¡ â†” 100:è±ªè¯"}, {n:"æœ€å¼·ã®å¿…æ®ºæŠ€", s:"1:å¼±å° â†” 100:æœ€å¼·"}, {n:"ä¼‘æ—¥ã®å……å®Ÿåº¦", s:"1:ç„¡é§„ â†” 100:æœ€é«˜"}, {n:"å­¦æ ¡ã®æ ¡å‰‡", s:"1:ç·©ã„ â†” 100:åœ°ç„"},
        {n:"æ–‡æˆ¿å…·ã®ä¾¿åˆ©ã•", s:"1:ä½ã„ â†” 100:é«˜ã„"}, {n:"ç†æƒ³ã®ãƒ—ãƒ­ãƒãƒ¼ã‚º", s:"1:æœ€æ‚ª â†” 100:æœ€é«˜"}, {n:"ã‚³ãƒ³ãƒ“ãƒ‹ã®ãŠè“å­", s:"1:ä¸äººæ°— â†” 100:äººæ°—"}, {n:"å¼·ãã†ãªãƒã‚±ãƒ¢ãƒ³", s:"1:å¼±ã„ â†” 100:å¼·ã„"}, {n:"ä¸€ç”Ÿé£Ÿã¹ç¶šã‘ãŸã„ã‚‚ã®", s:"1:å«Œ â†” 100:ç†æƒ³"}, {n:"è´…æ²¢ãªæ™‚é–“", s:"1:ç„¡é§„ â†” 100:æœ€é«˜"}, {n:"èº«ã«ã¤ã‘ãŸã„ã‚¹ã‚­ãƒ«", s:"1:ä¸è¦ â†” 100:å¿…é ˆ"}, {n:"ä¸–ç•Œå¹³å’Œã«å¿…è¦ãªã‚‚ã®", s:"1:ä¸è¦ â†” 100:å¿…é ˆ"}, {n:"å®‡å®™äººã®æ€–ã•", s:"1:æ€–ããªã„ â†” 100:æ€–ã„"}, {n:"ã‚¹ãƒãƒ¼ãƒ„ã®ãƒãƒ¼ãƒ‰ã•", s:"1:æ¥½ â†” 100:ã‚­ãƒ„ã‚¤"},
        {n:"æœ‰åäººã®å¥½æ„Ÿåº¦", s:"1:ä½ã„ â†” 100:é«˜ã„"}, {n:"æœã”ã¯ã‚“ã®ãŠã‹ãš", s:"1:ä¸è©• â†” 100:å¥½è©•"}, {n:"æœ€å¼·ã®ç›¾", s:"1:è„†ã„ â†” 100:ç¡¬ã„"}, {n:"ãŠç¥­ã‚Šã®å±‹å°", s:"1:ä¸äººæ°— â†” 100:äººæ°—"}, {n:"å¥½ããªå­£ç¯€", s:"1:å«Œã„ â†” 100:å¥½ã"}, {n:"ã‚¢ãƒ—ãƒªã®é‡è¦åº¦", s:"1:ä½ã„ â†” 100:é«˜ã„"}, {n:"æ†§ã‚Œã®å®¶", s:"1:ãƒœãƒ­ã„ â†” 100:è±ªè¯"}, {n:"ã‚«ãƒƒã‚³ã„ã„ä¹—ã‚Šç‰©", s:"1:ãƒ€ã‚µã„ â†” 100:æœ€é«˜"}, {n:"å­¦æ ¡è¡Œäº‹ã®æ¥½ã—ã•", s:"1:ä½ã„ â†” 100:é«˜ã„"}, {n:"1æ—¥å…¥ã‚Œæ›¿ã‚ã‚ŠãŸã„äºº", s:"1:å«Œ â†” 100:ç†æƒ³"},
        {n:"æœ€å¼·ã®ãƒ•ãƒ«ãƒ¼ãƒ„", s:"1:ä¸å‘³ã„ â†” 100:æœ€é«˜"}, {n:"ãŠé¢¨å‘‚ã§ã®è€ƒãˆäº‹", s:"1:ä¸‹ã‚‰ãªã„ â†” 100:é‡è¦"}, {n:"å¥½ããªã‚¢ã‚¤ã‚¹ã®å‘³", s:"1:ä¸äººæ°— â†” 100:äººæ°—"}, {n:"ã‚«ãƒƒã‚³ã„ã„æœã®ãƒ–ãƒ©ãƒ³ãƒ‰", s:"1:ãƒ€ã‚µã„ â†” 100:æœ€é«˜"}, {n:"ã‚¾ãƒ³ãƒ“ç”¨ã‚¢ã‚¤ãƒ†ãƒ ", s:"1:ä¸è¦ â†” 100:å¿…è¦"}, {n:"ç†æƒ³ã®ä¼‘æ—¥", s:"1:ä¸æº€ â†” 100:æº€è¶³"}, {n:"ä¾¿åˆ©ãªå®¶é›»", s:"1:ä½ã„ â†” 100:é«˜ã„"}, {n:"ç„¡æ•µã«ãªã‚Œã‚‹é£Ÿã¹ç‰©", s:"1:å¼±ã„ â†” 100:å¼·ã„"}, {n:"ã‚¿ã‚¤ãƒ ã‚¹ãƒªãƒƒãƒ—å…ˆ", s:"1:å«Œ â†” 100:ç†æƒ³"}, {n:"å¥½ããªè‰²", s:"1:å«Œã„ â†” 100:å¥½ã"},
        {n:"ã‚«ãƒƒã‚³ã„ã„æ¥½å™¨", s:"1:ãƒ€ã‚µã„ â†” 100:æœ€é«˜"}, {n:"æœ€å¼·ã®ã‚¹ãƒ¼ãƒ—", s:"1:ä¸å‘³ã„ â†” 100:æœ€é«˜"}, {n:"è¨€ã‚ã‚Œã¦å¬‰ã—ã„è¨€è‘‰", s:"1:ç„¡ â†” 100:æœ€é«˜"}, {n:"å°†æ¥ã®å¤¢ã®å¤§ãã•", s:"1:å°ã•ã„ â†” 100:å·¨å¤§"}, {n:"å¥½ããªé¦™æ°´", s:"1:è‡­ã„ â†” 100:è‰¯ã„é¦™ã‚Š"}, {n:"ä¸€ç•ªé¢ç™½ã„ã‚¢ãƒ‹ãƒ¡", s:"1:é€€å±ˆ â†” 100:çˆ†ç¬‘"}, {n:"æ—…è¡Œå…ˆãƒˆãƒ©ãƒ–ãƒ«", s:"1:è»½å¾® â†” 100:çµ¶æœ›"}, {n:"æœ€å¼·ã®ãƒ‘ãƒ³", s:"1:ä¸å‘³ã„ â†” 100:æœ€é«˜"}, {n:"æ”¾èª²å¾Œã®éã”ã—æ–¹", s:"1:é€€å±ˆ â†” 100:æœ€é«˜"}, {n:"æœ€å¼·ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°", s:"1:ä¸è¦ â†” 100:å¿…è¦"},
        {n:"ç†æƒ³ã®å…ˆç”Ÿ", s:"1:å«Œã„ â†” 100:å¥½ã"}, {n:"è‡ªåˆ†ã«ã¨ã£ã¦ã®è´…æ²¢", s:"1:è³ªç´  â†” 100:è±ªè¯"}, {n:"å¥½ããªYouTuber", s:"1:èª° â†” 100:ç¥"}, {n:"ã‚«ãƒƒã‚³ã„ã„é«ªå‹", s:"1:ãƒ€ã‚µã„ â†” 100:æœ€é«˜"}, {n:"ä¸€ç•ªç–²ã‚Œã‚‹æƒé™¤", s:"1:æ¥½ â†” 100:å¤§å¤‰"}, {n:"æœ€å¼·ã®ã‚³ãƒ³ãƒ“", s:"1:å¼±ã„ â†” 100:å¼·ã„"}, {n:"æ¬²ã—ã„è»Š", s:"1:ä¸è¦ â†” 100:æœ€é«˜"}, {n:"ä¸€ç•ªç·Šå¼µã™ã‚‹å ´é¢", s:"1:ä½™è£• â†” 100:æ¥µé™"}, {n:"ä¸€ç”Ÿã®æ€ã„å‡º", s:"1:å¿˜ã‚ŒãŸã„ â†” 100:å®ç‰©"}, {n:"æœ€å¼·ã®ãƒ‘ã‚¹ã‚¿", s:"1:ä¸å‘³ã„ â†” 100:æœ€é«˜"},
        {n:"å¥½ããªé§…å¼", s:"1:ä¸äººæ°— â†” 100:äººæ°—"}, {n:"æ¬²ã—ã„å®¶å…·", s:"1:ä¸è¦ â†” 100:å¿…é ˆ"}, {n:"ç†æƒ³ã®ç¡çœ æ™‚é–“", s:"1:çŸ­ã„ â†” 100:é•·ã„"}, {n:"æœ€é«˜ã®ãƒ©ãƒ¼ãƒ¡ãƒ³å±‹", s:"1:ä¸å‘³ã„ â†” 100:æœ€é«˜"}, {n:"æ­´å²çš„äº‹ä»¶ã®å‡„ã•", s:"1:åœ°å‘³ â†” 100:è¡æ’ƒ"}, {n:"æœ€å¼·ã®é‡èœ", s:"1:å«Œã„ â†” 100:å¥½ã"}, {n:"æ†§ã‚Œã®å›½", s:"1:å«Œ â†” 100:ç†æƒ³"}, {n:"ä¸€æ—¥ã®å§‹ã¾ã‚Šã®æ°—åˆ†", s:"1:æœ€æ‚ª â†” 100:æœ€é«˜"}, {n:"æœ€å¼·ã®ãŠã¤ã¾ã¿", s:"1:ä¸å‘³ã„ â†” 100:æœ€é«˜"}, {n:"é¿é›£ç”¨ã‚¢ã‚¤ãƒ†ãƒ ", s:"1:ä¸è¦ â†” 100:å¿…é ˆ"},
        {n:"èª•ç”Ÿæ—¥ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ", s:"1:å›°ã‚‹ â†” 100:å¬‰ã—ã„"}, {n:"ä¸€ç•ªæ¬²ã—ã„æœ", s:"1:ä¸è¦ â†” 100:æœ€é«˜"}, {n:"æœ€å¼·ã®ä¸¼ã‚‚ã®", s:"1:ä¸å‘³ã„ â†” 100:æœ€é«˜"}, {n:"è‡ªåˆ†ã®æ‰èƒ½", s:"1:ç„¡ â†” 100:å¤©æ‰"}, {n:"æœ€é«˜ã®æ¸©æ³‰åœ°", s:"1:å«Œ â†” 100:æœ€é«˜"}, {n:"ã‚¹ãƒãƒ›ã‚±ãƒ¼ã‚¹", s:"1:ãƒ€ã‚µã„ â†” 100:æœ€é«˜"}, {n:"æœ€å¼·ã®ã”é£¯ã®ãŠä¾›", s:"1:ä¸è¦ â†” 100:å¿…é ˆ"}, {n:"ç†æƒ³ã®å®¶æ—åƒ", s:"1:ä¸å¹¸ â†” 100:å¹¸ç¦"}, {n:"ä»Šä¸€ç•ªã—ãŸã„ã“ã¨", s:"1:ç„¡ â†” 100:åˆ‡å®Ÿ"}, {n:"å®ãã˜ã®ä½¿ã„é“", s:"1:åœ°å‘³ â†” 100:è±ªå¿«"}
    ],
    init() {
        document.getElementById('game-content').innerHTML = `
            <div id="ito-setup"><h3>THEME SELECT</h3><button onclick="Ito.suggest()" class="btn btn-orange">ãŠé¡Œã‚’å‡ºã™</button><div id="ito-opts"></div></div>
            <div id="ito-play" class="hidden">
                <div style="background:#f0f7ff; border:2px solid var(--blue); border-radius:10px; padding:10px; margin-bottom:15px;">
                    <h2 id="it-n" style="text-align:center; margin:0; color:var(--blue);"></h2>
                    <p id="it-s" style="text-align:center; font-size:0.9rem; font-weight:bold; margin:5px 0 0 0; color:#333;"></p>
                </div>
                <div id="it-field" style="text-align:center; min-height:80px;"></div>
                <div id="it-msg" style="text-align:center; font-weight:bold; margin:10px;"></div>
                <div id="it-notice" style="text-align:center; color:red; font-size:0.8rem; height:20px; margin-bottom:10px;"></div>
                <div class="hand-area"><div id="it-mynum" class="num-view">?</div>HOLD</div>
                <div id="it-control">
                    <button id="it-draw" onclick="Ito.draw()" class="btn btn-blue">æ•°å­—ã‚’å¼•ã</button>
                    <div id="it-actions" class="hidden">
                        <button onclick="Ito.draw()" class="btn btn-gray" style="margin-bottom:5px;">å¼•ãç›´ã™</button>
                        <button onclick="Ito.submit()" class="btn btn-orange">ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™</button>
                    </div>
                </div>
            </div>
            <span onclick="Ito.reset()" class="reset-link">HARD RESET</span>`;
        db.ref('ito').on('value', snap => {
            const d = snap.val() || {};
            if(d.config) {
                document.getElementById('ito-setup').classList.add('hidden'); document.getElementById('ito-play').classList.remove('hidden');
                document.getElementById('it-n').innerText = d.config.theme; document.getElementById('it-s').innerText = d.config.scale;
            } else {
                document.getElementById('ito-setup').classList.remove('hidden'); document.getElementById('ito-play').classList.add('hidden');
                document.getElementById('ito-opts').innerHTML = (d.proposals||[]).map((p,i)=>`<button class="btn btn-gray" onclick="Ito.select(${i})">${p.n}</button>`).join('');
                this.drawCount = 0; // ãƒªã‚»ãƒƒãƒˆ
            }
            // é€šçŸ¥ã®è¡¨ç¤º
            const noticeEl = document.getElementById('it-notice');
            if(d.lastRedraw && d.lastRedraw.user !== "none") {
                noticeEl.innerText = `âš ï¸ ${d.lastRedraw.user}ãŒ${d.lastRedraw.count}å›ç›®ã®å¼•ãç›´ã—ï¼`;
            } else {
                noticeEl.innerText = "";
            }
            const f = document.getElementById('it-field'); f.innerHTML = "";
            if(d.cards) {
                let last=0, fail=false;
                Object.values(d.cards).sort((a,b)=>a.ts-b.ts).forEach(c => {
                    if(c.num < last) fail = true;
                    f.innerHTML += `<div class="ito-card" style="border-color:${fail?'red':'#004098'}"><span>${c.num}</span><small style="font-size:0.5rem;">${c.user}</small></div>`;
                    last = c.num;
                });
                document.getElementById('it-msg').innerText = fail ? "FAILED" : "STABLE";
            }
        });
    },
    suggest() { db.ref('ito/proposals').set(this.themes.sort(()=>0.5-Math.random()).slice(0,3)); },
    select(i) { db.ref('ito/proposals').once('value', s=>{ const p=s.val(); if(p) db.ref('ito/config').set({theme:p[i].n, scale:p[i].s}); }); },
    draw() { 
        this.myNum = Math.floor(Math.random()*100)+1; 
        this.drawCount++;
        document.getElementById('it-mynum').innerText = this.myNum; 
        document.getElementById('it-draw').classList.add('hidden'); 
        document.getElementById('it-actions').classList.remove('hidden'); 
        // å…¨å“¡ã«é€šçŸ¥
        if(this.drawCount > 1) {
            db.ref('ito/lastRedraw').set({user: Core.user, count: this.drawCount});
        }
    },
    submit() { 
        db.ref('ito/cards').push({num:this.myNum, user:Core.user, ts:Date.now()}); 
        db.ref('ito/lastRedraw').set({user: "none", count: 0}); // é€šçŸ¥ã‚’æ¶ˆã™
        document.getElementById('it-actions').classList.add('hidden'); 
    },
    reset() { if(confirm("RESET?")) db.ref('ito').remove(); }
};
// --- DECRYPTO SYSTEM (Fix V5.5) ---
const Decrypto = {
    role: "", isJudging: false,
    wordsList: ["å­¦æ ¡","ãƒªãƒ³ã‚´","å®‡å®™","ã‚®ã‚¿ãƒ¼","ã‚«ãƒ¡ãƒ©","å¯¿å¸","é›»è©±","æµ·","å±±","æ™‚è¨ˆ","æœ¬","é³¥","èŠ±","é´","æ¤…å­","ã‚«ãƒ¬ãƒ¼","é›»è»Š","å…¬åœ’","ãƒ”ã‚¢ãƒ","å¤ªé™½","ç ‚æ¼ ","å†·è”µåº«","çœ¼é¡","æœˆ","æ˜ ç”»","é‡çƒ","ãƒ©ãƒ¼ãƒ¡ãƒ³","ç§˜å¯†","ãŠé¢¨å‘‚","éµ","é£›è¡Œæ©Ÿ","ãŠã«ãã‚Š","å¿è€…","é­”æ³•","ãƒ­ãƒœãƒƒãƒˆ","ãƒˆãƒ©ãƒ³ãƒ—","æ£®","ç—…é™¢","ãƒ‘ãƒ³ãƒ€","èŠ±ç«","å¹½éœŠ","ã‚«ãƒ‹","è¾æ›¸","å®ç®±","ãƒšãƒ³ã‚®ãƒ³","åœ°å›³","æ‰‹ç´™","æ´—æ¿¯æ©Ÿ","åŸ","æç«œ","å‚˜","é¢¨èˆ¹","æ¶ˆã—ã‚´ãƒ ","ç ‚å ´","æœ›é é¡","ãƒˆãƒ¼ã‚¹ã‚¿ãƒ¼","åˆ‡æ‰‹","æ­¯ãƒ–ãƒ©ã‚·","ä¿¡å·æ©Ÿ","æ‰‡é¢¨æ©Ÿ","ã‚«ãƒ–ãƒˆãƒ ã‚·","æ•™ç§‘æ›¸","ã‚³ãƒ³ãƒ‘ã‚¹","åŒ–çŸ³","ç„šãç«","æ½œæ°´è‰¦","ãƒãƒ³ãƒãƒ¼ã‚°","éŠåœ’åœ°","å›³æ›¸é¤¨","æ°´æ—é¤¨","ã‚­ãƒ£ãƒ³ãƒ—","è‡ªè»¢è»Š","ã‚µãƒƒã‚«ãƒ¼","é‡‘é­š","æµã‚Œæ˜Ÿ","æ‰‹è¢‹","ãƒã‚¹ã‚¯","ãƒãƒ³ãƒˆ","æ‡ä¸­é›»ç¯","å¤§ä»","ãƒ”ã‚¶","ç¥ç¤¾","ãŠå¯º","ç ‚æ™‚è¨ˆ","æµ®è¼ª","é¡","å®çŸ³","å‰£","ç›¾","ç‹å† ","é›ªã ã‚‹ã¾","ãƒ˜ãƒªã‚³ãƒ—ã‚¿ãƒ¼","ã‚µãƒœãƒ†ãƒ³","é‡‘åº«","çœŸç ","ä¸‡è¯é¡","åœ°çƒå„€","é‰›ç­†å‰Šã‚Š","æ–¹ä½ç£çŸ³","ç›®è¦šã¾ã—æ™‚è¨ˆ","æ‰‡å­","æ‰“ã¡ä¸Šã’èŠ±ç«","ã‚¯ãƒªãƒƒãƒ—","ãƒ‘ã‚ºãƒ«","æ„›","è‡ªç”±","æ­£ç¾©","å¹³å’Œ","æœªæ¥","éå»","å¸Œæœ›","å­¤ç‹¬","å‹‡æ°—","ææ€–","æ¬²æœ›","ç†æ€§","æœ¬èƒ½","ä¼çµ±","é€²åŒ–","èŠ¸è¡“","é‹å‘½","å¥‡è·¡","æ²ˆé»™","å«‰å¦¬","ä¿¡é ¼","èª‡ã‚Š","æƒ…ç†±","ç†æƒ³","ç¾å®Ÿ","æŒ‘æˆ¦","å‹åˆ©","æ•—åŒ—","æ°¸é ","ç¬é–“"],
    init() {
        document.getElementById('game-content').innerHTML = `
            <div id="de-ui">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <h3 id="de-r-view" style="margin:0;">DECRYPTO</h3>
                    <div id="de-chips" style="font-size:0.8rem; font-weight:bold;">
                        <span style="color:var(--orange);">é»’æ’ƒ: <span id="chip-b">0</span>/2</span> | <span style="color:var(--blue);">ç™½ãƒŸã‚¹: <span id="chip-w">0</span>/2</span>
                    </div>
                </div>
                <div id="de-setup" style="text-align:center; padding:15px; background:#f0f0f0; border-radius:10px; border:2px solid #ccc;">
                    <div style="display:flex; justify-content:space-around; margin-bottom:15px;">
                        <div style="width:45%; background:white; border:2px solid var(--blue); border-radius:8px; padding:10px;"><h4 style="color:var(--blue); margin:0 0 10px 0;">WHITE</h4><div id="list-w" style="font-size:0.85rem; min-height:50px; color:#333;"></div><button onclick="Decrypto.move('W')" class="btn btn-blue" style="width:100%; font-size:0.8rem;">å…¥ã‚‹</button></div>
                        <div style="width:45%; background:white; border:2px solid var(--orange); border-radius:8px; padding:10px;"><h4 style="color:var(--orange); margin:0 0 10px 0;">BLACK</h4><div id="list-b" style="font-size:0.85rem; min-height:50px; color:#333;"></div><button onclick="Decrypto.move('B')" class="btn btn-orange" style="width:100%; font-size:0.8rem;">å…¥ã‚‹</button></div>
                    </div>
                    <button id="de-start-btn" onclick="Decrypto.startGame()" class="btn btn-gray" style="width:80%;" disabled>GAME START</button>
                </div>
                <div id="de-board" class="hidden">
                    <div id="de-info" style="text-align:center; font-size:0.8rem; font-weight:bold; padding:5px; border-radius:5px; margin-bottom:10px;"></div>
                    <div id="de-history" style="display:flex; gap:3px; margin-bottom:10px;">
                        ${[1,2,3,4].map(i => `<div style="flex:1; background:#fff; border:1px solid #ddd; font-size:0.6rem; padding:3px; border-radius:4px; min-height:60px;"><b>${i}:<span id="h-kw${i}">?</span></b><div id="hl${i}" style="color:#666; font-size:0.55rem; line-height:1.1; margin-top:2px;"></div></div>`).join('')}
                    </div>
                    <div class="kw-grid"><div class="kw-box" id="dw1">?</div><div class="kw-box" id="dw2">?</div><div class="kw-box" id="dw3">?</div><div class="kw-box" id="dw4">?</div></div>
                    <div id="black-memo-area" class="hidden" style="margin-top:10px;"><input id="de-memo" oninput="Decrypto.saveMemo()" placeholder="é»’ãƒãƒ¼ãƒ å…±æœ‰ãƒ¡ãƒ¢..." style="width:100%; font-size:0.7rem; padding:5px; border:1px solid var(--orange); border-radius:5px; background:#fff8f4;"></div>
                    <div id="de-ctrl" style="padding:15px; background:#f4f4f4; border-radius:10px; margin-top:10px; border:1px solid #ddd;"></div>
                    <table class="log-table" style="font-size:0.65rem; margin-top:10px;"><thead><tr><th>R</th><th>ãƒ’ãƒ³ãƒˆ</th><th>æ­£è§£</th><th>ç™½/é»’</th></tr></thead><tbody id="de-log"></tbody></table>
                </div>
                <span onclick="Decrypto.reset()" class="reset-link">HARD RESET</span>
            </div>`;
        this.listen();
    },
    listen() {
        db.ref('de').on('value', snap => {
            const d = snap.val() || {};
            if(!d.words) { db.ref('de/words').set(this.wordsList.sort(()=>0.5-Math.random()).slice(0,4)); return; }
            const players = d.players || {}, members = Object.entries(players);
            const whiteTeam = members.filter(p => p[1].team === 'W').map(p => p[1].name);
            const blackTeam = members.filter(p => p[1].team === 'B').map(p => p[1].name);
            const bChips = d.blackChips || 0, wChips = d.whiteChips || 0;
            document.getElementById('chip-b').innerText = bChips; document.getElementById('chip-w').innerText = wChips;
            if(bChips >= 2) { alert("é»’ãƒãƒ¼ãƒ å‹åˆ©ï¼(å‚å—2)"); this.reset(); return; }
            if(wChips >= 2) { alert("ç™½ãƒãƒ¼ãƒ æ•—åŒ—ï¼(ãƒŸã‚¹2)"); this.reset(); return; }

            if(!d.started) {
                document.getElementById('de-setup').classList.remove('hidden'); document.getElementById('de-board').classList.add('hidden');
                document.getElementById('list-w').innerText = whiteTeam.join(', '); document.getElementById('list-b').innerText = blackTeam.join(', ');
                const canStart = whiteTeam.length >= 2 && blackTeam.length >= 1;
                const sBtn = document.getElementById('de-start-btn'); sBtn.disabled = !canStart; sBtn.className = canStart ? "btn btn-orange" : "btn btn-gray";
                if(!members.find(p => p[1].uid === Core.user)) db.ref('de/players').push({uid: Core.user, name: Core.user, team: 'W'});
                return;
            }

            document.getElementById('de-setup').classList.add('hidden'); document.getElementById('de-board').classList.remove('hidden');
            const me = members.find(p => p[1].uid === Core.user); this.role = me ? me[1].team : "";
            const round = (d.logs ? Object.keys(d.logs).length : 0) + 1;
            document.getElementById('de-r-view').innerText = `Round ${round}`;
            
            // å˜èªã¨å±¥æ­´ã®æ›´æ–°
            const hists = {1:[], 2:[], 3:[], 4:[]};
            if(d.logs) Object.values(d.logs).forEach(l => {
                const hs = l.h.split(' / '), cs = String(l.c).split('');
                cs.forEach((num, idx) => { if(hists[num]) hists[num].push(hs[idx]); });
            });
            [1,2,3,4].forEach(i => {
                document.getElementById('dw'+i).innerText = (this.role==='W' ? i+': '+d.words[i-1] : '?');
                document.getElementById('h-kw'+i).innerText = (this.role==='W' ? d.words[i-1] : '?');
                document.getElementById('hl'+i).innerText = hists[i].join(', ');
            });

            // é»’ãƒãƒ¼ãƒ å°‚ç”¨ãƒ¡ãƒ¢ã®åŒæœŸ
            const memoArea = document.getElementById('black-memo-area');
            if(this.role==='B') { memoArea.classList.remove('hidden'); document.getElementById('de-memo').value = d.memo || ""; }
            else { memoArea.classList.add('hidden'); }

            const maker = whiteTeam[(round - 1) % whiteTeam.length];
            const infoEl = document.getElementById('de-info');
            infoEl.innerText = `ãƒãƒ¼ãƒ : ${this.role==='W'?'ç™½':'é»’'} / è¦ª: ${maker}`;
            infoEl.style.background = (this.role==='W' ? '#eef6ff' : '#fff4ee');

            const ctrl = document.getElementById('de-ctrl');
            if(!d.hints) {
                if(this.role==='W' && Core.user === maker) {
                    if(!d.code) db.ref('de/code').set([1,2,3,4].sort(()=>0.5-Math.random()).slice(0,3).join(''));
                    ctrl.innerHTML = `æš—å·: <b style="font-size:1.8rem; color:red;">${d.code||'..'}</b><div style="display:flex; gap:5px; margin-top:10px;"><input id="h1" class="btn btn-gray" placeholder="H1" style="width:33%"><input id="h2" class="btn btn-gray" placeholder="H2" style="width:33%"><input id="h3" class="btn btn-gray" placeholder="H3" style="width:33%"></div><button onclick="Decrypto.sendH()" class="btn btn-orange" style="width:100%; margin-top:10px;">ãƒ’ãƒ³ãƒˆé€ä¿¡</button>`;
                } else { ctrl.innerHTML = `<center>ç™½ã®è¦ªã€Œ${maker}ã€ãŒè€ƒãˆä¸­...</center>`; }
            } else {
                if(this.role==='W' && Core.user!==maker && !d.ansW) {
                    ctrl.innerHTML = `ãƒ’ãƒ³ãƒˆ: <b>${d.hints}</b><input id="ain" type="number" class="btn btn-gray" placeholder="3æ¡å›ç­”" style="width:100%; margin:10px 0;"><button onclick="Decrypto.sendA('W')" class="btn btn-blue" style="width:100%;">é€£æºå›ç­”</button>`;
                } else if(this.role==='B' && !d.ansB) {
                    ctrl.innerHTML = `ãƒ’ãƒ³ãƒˆ: <b>${d.hints}</b><input id="ain" type="number" class="btn btn-gray" placeholder="3æ¡å‚å—" style="width:100%; margin:10px 0;"><button onclick="Decrypto.sendA('B')" class="btn btn-orange" style="width:100%;">å‚å—æ”»æ’ƒ</button>`;
                } else { ctrl.innerHTML = `<center>ãƒ’ãƒ³ãƒˆ: ${d.hints}<br><small>å›ç­”å¾…æ©Ÿä¸­...</small></center>`; }
                if(Core.user===maker && d.ansW && d.ansB && !this.isJudging) { this.isJudging = true; this.judge(round, d); }
            }
            const lb = document.getElementById('de-log'); lb.innerHTML = "";
            if(d.logs) Object.values(d.logs).reverse().forEach(l => {
                lb.innerHTML += `<tr><td>${l.r}</td><td>${l.h}</td><td>${l.c}</td><td>ç™½:${l.wRes} / é»’:${l.bRes}</td></tr>`;
            });
        });
    },
    saveMemo() { const v = document.getElementById('de-memo').value; db.ref('de/memo').set(v); },
    startGame() { 
        const code = [1,2,3,4].sort(()=>0.5-Math.random()).slice(0,3).join('');
        db.ref('de').update({ started: true, code: code, blackChips: 0, whiteChips: 0, memo: "" }); 
    },
    sendH() { const h = [document.getElementById('h1').value, document.getElementById('h2').value, document.getElementById('h3').value].join(' / '); if(h.length > 5) db.ref('de/hints').set(h); },
    sendA(t) { const v = document.getElementById('ain').value; if(v.length===3) db.ref('de/ans'+t).set(v); },
    judge(r, d) {
        const bOk = (String(d.ansB)===String(d.code)), wOk = (String(d.ansW)===String(d.code));
        const up = {}; up[`de/logs/r${Date.now()}`] = { r: r, h: d.hints, c: d.code, wRes: wOk?"â—‹":"Ã—", bRes: bOk?"â—‹":"Ã—" };
        up[`de/hints`] = null; up[`de/ansW`] = null; up[`de/ansB`] = null;
        up[`de/code`] = [1,2,3,4].sort(()=>0.5-Math.random()).slice(0,3).join('');
        up[`de/blackChips`] = (d.blackChips || 0) + (bOk ? 1 : 0);
        up[`de/whiteChips`] = (d.whiteChips || 0) + (wOk ? 0 : 1);
        db.ref().update(up).then(() => this.isJudging = false);
    },
    reset() { if(confirm("RESET?")) db.ref('de').remove(); }
};
</script>
</body>
</html>
